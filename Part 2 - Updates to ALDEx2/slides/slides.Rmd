---
title: "Scale Uncertainty in ALDEx2"
author: "Michelle Nixon"
date: "May 13, 2024"
output: beamer_presentation
header-includes:
  \usepackage{dcolumn}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```



## Recap: Sequencing depth can confound conclusions.

\begin{table}[h!]
\centering
\begin{tabular}{|r|c c c| c|}
\hline
\textcolor{gray}{Observed data (Y)} & Sample 1 & Sample 2 & Sample 3  &\\
\hline
Condition & Health & Health & Disease & \textcolor{gray}{Conclusion}\\
\hline
Entity 1 & 5 & 10 & 100 & \textcolor{gray}{Increase}\\
Entity 2 & 10 & 25 & 3 & \textcolor{gray}{Decrease}\\
Entity 3 & 0 & 1 & 8 & \textcolor{gray}{Increase}\\
Entity 4 & 0 & 0 & 19 &\textcolor{gray}{Increase}\\
\hline
\textcolor{gray}{Sampling Depth} & \textcolor{gray}{15} & \textcolor{gray}{36} & \textcolor{gray}{130} &\\
\hline
\end{tabular}
\end{table}


## This can mislead analyses.

\begin{table}[h!]
\centering
\begin{tabular}{|r|c c c| c|}
\hline
\textcolor{gray}{System data (W)} & Sample 1 & Sample 2 & Sample 3  & \\
\hline
Condition & Health & Health & Disease & \textcolor{gray}{Conclusion}\\
\hline
Entity 1 & 227 & 351 & 154 & \textcolor{gray}{Decrease}\\
Entity 2 & 684 & 891 & 3 & \textcolor{gray}{Decrease}\\
Entity 3 & 48 & 32 & 15 & \textcolor{gray}{Decrease}\\
Entity 4 & 43 & 39  & 27 &\textcolor{gray}{Decrease}\\
\hline
\textcolor{gray}{Scale ($W^\perp$)} & \textcolor{gray}{1,002} & \textcolor{gray}{1,313} & \textcolor{gray}{200} &\\
\hline
\end{tabular}
\end{table}

## ... and lead to unacknowledged bias.

\begin{figure}
  \centering
  \includegraphics[width=4.5in]{figures/unacknowledged_bias.pdf}
\end{figure}

# Problem Set-Up

## Observed Data as a Sample from the System

\begin{figure}
  \centering
  \includegraphics[width=4.5in]{figures/intro.pdf}
\end{figure}

## Notation

- $Y$ is a measurement of the underlying system $W$.

- $W$ depends on both the composition ($W_{dn}^\parallel$) and system scale ($W_n^\perp$):

$$W_{dn} = W_{dn}^\parallel W_n^\perp$$
$$W_n^\perp = \sum_{d=1}^D W_{dn}$$

- $\theta$ is what we want to estimate. 

## Differential Abundance/Expression Analysis

- Question: How do entities (e.g., taxa or genes) change between conditions?

- In this case, $\theta$ is the log-fold change (LFC):

\begin{equation*}
\theta_d = \text{mean}_{\text{case}}(\log W_{dn}) - \text{mean}_{\text{control}}(\log W_{dn})
\end{equation*}

## The Original ALDEx2 Model

\textbf{Step 1: Model Sampling Uncertainty}
\begin{align*}
Y_{\cdot n} &\sim \text{Multinomial}(W_{\cdot n}^\parallel)\\
W_{\cdot n}^\parallel &\sim \text{Dirichlet}(\alpha)
\end{align*}

\textbf{Step 2: Centered Log-Ratio Transformation}
\begin{equation*}
\log W_{\cdot n} = \left[\log W_{1n}^\parallel - \text{mean}(\log W_{\cdot n}^\parallel), ..., \log W_{Dn}^\parallel - \text{mean}(\log W_{\cdot n}^\parallel) \right]
\end{equation*}

\textbf{Step 3: Calculate LFCs and Test if Different from Zero.}
\begin{equation*}
\theta_d = \text{mean}_{\text{case}}(\log W_{dn}) - \text{mean}_{\text{control}}(\log W_{dn})
\end{equation*}

## Implied Assumptions about Scale

\textcolor{gray}{\textbf{Step 1: Model Sampling Uncertainty}}
\textcolor{gray}{\begin{align*}
Y_{\cdot n} &\sim \text{Multinomial}(W_{\cdot n}^\parallel)\\
W_{\cdot n}^\parallel &\sim \text{Dirichlet}(\alpha)
\end{align*}}

\textbf{Step 2: Centered Log-Ratio Transformation}
\begin{equation*}
\log W_{\cdot n} = \left[\log W_{1n}^\parallel - \text{mean}(\log W_{\cdot n}^\parallel), ..., \log W_{Dn}^\parallel - \text{mean}(\log W_{\cdot n}^\parallel) \right]
\end{equation*}

\textcolor{gray}{\textbf{Step 3: Calculate LFCs and Test if Different from Zero.}}
\textcolor{gray}{\begin{equation*}
\theta_d = \text{mean}_{\text{case}}(\log W_{dn}) - \text{mean}_{\text{control}}(\log W_{dn})
  \end{equation*}}
  
## Implied Assumptions about Scale, cont.
Using the relationship $W_{dn} = W_{dn}^\parallel W_n^\perp$ and some math, the CLR normalization implies:

\begin{align*}
\log W_n^\perp = \text{mean}(\log W_{\cdot n}^\parallel).
\end{align*}

\textcolor{gray}{What does this mean? What does this imply for analyses?}


## Unacknowledged bias!

\begin{figure}
  \centering
  \includegraphics[width=4.5in]{figures/unacknowledged_bias.pdf}
\end{figure}

## Adding Uncertainty in Scale can Help.

\begin{figure}
  \centering
  \includegraphics[width=3.25in]{figures/sim-res.pdf}
\end{figure}


# Scale Reliant Inference (Informal)

## Scale Reliant Inference: The Basics

- **The CoDA perspective:** Research questions that depend on scale are not possible.

- **The Normalization perspective:** Research questions that depend on scale can be answered after normalization.

- Who is right?

\textcolor{white}{CoDA perspective: Technically yes, but limiting.}

\textcolor{white}{The Normalization perspective: Technically no, but attempting to answer relevant questions.}

## Scale Reliant Inference: The Basics

- **The CoDA perspective:** Research questions that depend on scale are not possible.

- **The Normalization perspective:** Research questions that depend on scale can be answered after normalization.

- Who is right?

- **The CoDA perspective:** Technically yes, but limiting.

- **The Normalization perspective:** Technically no, but attempting to answer relevant questions.

## Scale Reliant Inference: The Basics

- What happens if $\theta$ depends on $W^\perp$?

- Consider LFCs: how are taxa changing between two conditions?

\begin{align*}
\theta_d &= \text{mean}_{\text{case}}(\log W_{dn}) - \text{mean}_{\text{control}}(\log W_{dn})\\
&= ... \\
&= (\text{mean}_{\text{case}}(\log W_{dn}^\parallel) - \text{mean}_{\text{control}}(\log W_{dn}^\parallel))\\
&- (\text{mean}_{\text{case}}(\log W_{n}^\perp) - \text{mean}_{\text{control}}(\log W_{n}^\perp))\\
&= \theta^\parallel + \theta^\perp
\end{align*}

\textcolor{gray}{Don't we need $\theta^\perp$?}

## Scale Reliant Inference: Theory Intro
Recall for LFCs:
\begin{align*}
\theta_d &= \text{mean}_{\text{case}}(\log W_{dn} ) - \text{mean}_{\text{control}}(\log W_{dn} )\\
&= \theta^\parallel + \theta^\perp
\end{align*}

- What can we say about $\theta$ from $\theta^\parallel$ alone?

- E.g. If $\theta^\parallel = 20$, what does that say about $\theta$? \textcolor{gray}{If there are no restrictions, nothing!}

- Statistical perspective: $\theta$ is not identifiable without $\theta^\perp$.

- Practical issues: unbiased estimators, calibrated confidence sets, and type-I error control *NOT* possible!

## Scale Simulation Random Variables

**Goal:** Estimate $\theta = f(W^\parallel, W^\perp)$.

\vspace{.25in}

1. Draw samples of $W^{\parallel}$ from a measurement model (can depend on $Y$).

2. Draw samples of $W^{\perp}$ from a scale model (can depend on $W^{\parallel}$).

3. Estimate samples of $\theta = f(W^\parallel, W^\perp)$.


# The Updated ALDEx2 Software

## ALDEx2 as an SSRV

\textcolor{gray}{\textbf{Step 1: Model Sampling Uncertainty}}
\textcolor{gray}{\begin{align*}
Y_{\cdot n} &\sim \text{Multinomial}(W_{\cdot n}^\parallel)\\
W_{\cdot n}^\parallel &\sim \text{Dirichlet}(\alpha)
\end{align*}}

\textbf{Step 2: Draw Samples from a Scale Model}
\begin{align*}
\log W_{n}^\perp &\sim Q\\
\log W_{\cdot n} &= \log W_{\cdot n}^\parallel + \log W_{n}^\perp
\end{align*}

\textcolor{gray}{\textbf{Step 3: Calculate LFCs and Test if Different from Zero.}}
\textcolor{gray}{\begin{equation*}
\theta_d = \text{mean}_{\text{case}}(\log W_{dn}) - \text{mean}_{\text{control}}(\log W_{dn})
  \end{equation*}}

## Benefits of Moving Past Normalizations to Scale

\begin{figure}
  \centering
  \includegraphics[width=3.25in]{figures/sim-res-samples.pdf}
\end{figure}

## Intro to Scale Models

Normalizations are replaced by a scale model:

$$\log W_n^\perp \sim Q$$

There are no restrictions on $Q$, although there are some helpful options:

1. Based on normalizations.
2. Based on biological knowledge.
3. Based on outside measurements.

# Coding Changes to ALDEx2

## Including scale

**The new ALDEx2 model removes normalizations in lieu of scale models.**

Major updates:

1. A new argument `gamma` which inc

## The gamma argument

- Added as argument to the `aldex` and `aldex.clr` function.

- `gamma` can either be a single numeric or a matrix.
    1. Single numeric: controls the noise on the default scale model.
    2. Matrix: A $N \times S$ matrix of samples of $W$.
    
- `gamma = NULL` returns the default behavior of ALDEx2.

## Option 1: Default Scale Model

The default scale model is based on errors in the CLR normalization.

$$\log \hat{W}_{n}^{\perp(s)} = - \mathrm{mean} \left(\log \hat{W}^{\parallel (s)}_{\cdot n}\right) + \Lambda^\perp x_{n}$$
$$\Lambda^\perp  \sim \ N(0, \gamma^2).$$

## Advantages of the Default Scale Model

1. It is built off the status quo for ALDEx2.

2. Any value of $\gamma > 0$ will reduce false positives compared to the CLR normalization.

3. It has a concrete interpretation to contextualize scale assumptions.

## Interpreting the Default Scale Model

## Option 2: More Complex Scale Models

Alternatively, can pass a matrix of scale samples to `gamma` so long as:

1. The dimension is $N \times S$.
2. They are samples of $W^\perp$ not $\log W^\perp$.

Reasons to do this:

1. **Biological beliefs:** Scale is guided by the biological system or the researcher's prior beliefs.

2. **Outside Measurements:** These can be used in building a scale model *if* they are informative on the scale of interest (e.g., qPCR, flow cytometry).

## Sensitivity Analyses

# Real Data Examples

## Real Example: SELEX

## Real Example: Vandputte
