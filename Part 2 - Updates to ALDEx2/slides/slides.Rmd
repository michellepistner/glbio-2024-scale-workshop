---
title: "Scale Uncertainty in ALDEx2"
author: "Michelle Nixon"
date: "May 13, 2024"
output: beamer_presentation
header-includes:
  \usepackage{dcolumn}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```



## Recap: Sequencing depth can confound conclusions.

\begin{table}[h!]
\centering
\begin{tabular}{|r|c c c| c|}
\hline
\textcolor{gray}{Observed data (Y)} & Sample 1 & Sample 2 & Sample 3  &\\
\hline
Condition & Health & Health & Disease & \textcolor{gray}{Conclusion}\\
\hline
Entity 1 & 5 & 10 & 100 & \textcolor{gray}{Increase}\\
Entity 2 & 10 & 25 & 3 & \textcolor{gray}{Decrease}\\
Entity 3 & 0 & 1 & 8 & \textcolor{gray}{Increase}\\
Entity 4 & 0 & 0 & 19 &\textcolor{gray}{Increase}\\
\hline
\textcolor{gray}{Sampling Depth} & \textcolor{gray}{15} & \textcolor{gray}{36} & \textcolor{gray}{130} &\\
\hline
\end{tabular}
\end{table}


## This can mislead analyses.

\begin{table}[h!]
\centering
\begin{tabular}{|r|c c c| c|}
\hline
\textcolor{gray}{System data (W)} & Sample 1 & Sample 2 & Sample 3  & \\
\hline
Condition & Health & Health & Disease & \textcolor{gray}{Conclusion}\\
\hline
Entity 1 & 227 & 351 & 154 & \textcolor{gray}{Decrease}\\
Entity 2 & 684 & 891 & 3 & \textcolor{gray}{Decrease}\\
Entity 3 & 48 & 32 & 15 & \textcolor{gray}{Decrease}\\
Entity 4 & 43 & 39  & 27 &\textcolor{gray}{Decrease}\\
\hline
\textcolor{gray}{Scale ($W^\perp$)} & \textcolor{gray}{1,002} & \textcolor{gray}{1,313} & \textcolor{gray}{200} &\\
\hline
\end{tabular}
\end{table}

## ... and lead to unacknowledged bias.

\begin{figure}
  \centering
  \includegraphics[width=4.5in]{figures/unacknowledged_bias.pdf}
\end{figure}

# Problem Set-Up

## Observed Data as a Sample from the System

## Notation

- $Y$ is a measurement of the underlying system $W$.

- $W$ depends on both the composition ($W_{dn}^\parallel$) and system scale ($W_n^\perp$):

$$W_{dn} = W_{dn}^\parallel W_n^\perp$$
$$W_n^\perp = \sum_{d=1}^D W_{dn}$$

- $\theta$ is what we want to estimate. 

## Differential Abundance/Expression Analysis

- Question: How do entities (e.g., taxa or genes) change between conditions?

- In this case, $\theta$ is the log-fold change (LFC):

\begin{equation*}
\theta_d = \text{mean}_{\text{case}}(\log W_{dn}) - \text{mean}_{\text{control}}(\log W_{dn})
\end{equation*}

## The Original ALDEx2 Model

\textbf{Step 1: Model Sampling Uncertainty}
\begin{align*}
Y_{\cdot n} &\sim \text{Multinomial}(W_{\cdot n}^\parallel)\\
W_{\cdot n}^\parallel &\sim \text{Dirichlet}(\alpha)
\end{align*}

\textbf{Step 2: Centered Log-Ratio Transformation}
\begin{equation*}
\log W_{\cdot n} = \left[\log W_{1n}^\parallel - \text{mean}(\log W_{\cdot n}^\parallel), ..., \log W_{Dn}^\parallel - \text{mean}(\log W_{\cdot n}^\parallel) \right]
\end{equation*}

\textbf{Step 3: Calculate LFCs and Test if Different from Zero.}
\begin{equation*}
\theta_d = \text{mean}_{\text{case}}(\log W_{dn}) - \text{mean}_{\text{control}}(\log W_{dn})
\end{equation*}

## Implied Assumptions about Scale

\textcolor{gray}{\textbf{Step 1: Model Sampling Uncertainty}}
\textcolor{gray}{\begin{align*}
Y_{\cdot n} &\sim \text{Multinomial}(W_{\cdot n}^\parallel)\\
W_{\cdot n}^\parallel &\sim \text{Dirichlet}(\alpha)
\end{align*}}

\textbf{Step 2: Centered Log-Ratio Transformation}
\begin{equation*}
\log W_{\cdot n} = \left[\log W_{1n}^\parallel - \text{mean}(\log W_{\cdot n}^\parallel), ..., \log W_{Dn}^\parallel - \text{mean}(\log W_{\cdot n}^\parallel) \right]
\end{equation*}

\textcolor{gray}{\textbf{Step 3: Calculate LFCs and Test if Different from Zero.}}
\textcolor{gray}{\begin{equation*}
\theta_d = \text{mean}_{\text{case}}(\log W_{dn}) - \text{mean}_{\text{control}}(\log W_{dn})
  \end{equation*}}
  
## Implied Assumptions about Scale, cont.


## Adding Uncertainty in Scale can Help.

# Scale Reliant Inference (Informal)

## Scale Reliant Inference: The Basics

## Scale Reliant Inference: The Basics

- What happens if $\theta$ depends on $W^\perp$?

- Consider LFCs: how are taxa changing between two conditions?

\begin{align*}
\theta_d &= \text{mean}_{\text{case}}(\log W_{dn}) - \text{mean}_{\text{control}}(\log W_{dn})\\
&= ... \\
&= (\text{mean}_{\text{case}}(\log W_{dn}^\parallel) - \text{mean}_{\text{control}}(\log W_{dn}^\parallel))\\
&- (\text{mean}_{\text{case}}(\log W_{n}^\perp) - \text{mean}_{\text{control}}(\log W_{n}^\perp))\\
&= \theta^\parallel + \theta^\perp
\end{align*}

\textcolor{gray}{Don't we need $\theta^\perp$?}

## Scale Reliant Inference: Theory Intro
Recall for LFCs:
\begin{align*}
\theta_d &= \text{mean}_{\text{case}}(\log W_{dn} ) - \text{mean}_{\text{control}}(\log W_{dn} )\\
&= \theta^\parallel + \theta^\perp
\end{align*}

- What can we say about $\theta$ from $\theta^\parallel$ alone?

- E.g. If $\theta^\parallel = 20$, what does that say about $\theta$? \textcolor{gray}{If there are no restrictions, nothing!}

- Statistical perspective: $\theta$ is not identifiable without $\theta^\perp$.

- Practical issues: unbiased estimators, calibrated confidence sets, and type-I error control *NOT* possible!

## Scale Simulation Random Variables

**Goal:** Estimate $\theta = f(W^\parallel, W^\perp)$.

\vspace{.25in}

1. Draw samples of $W^{\parallel}$ from a measurement model (can depend on $Y$).

2. Draw samples of $W^{\perp}$ from a scale model (can depend on $W^{\parallel}$).

3. Estimate samples of $\theta = f(W^\parallel, W^\perp)$.


# The Updated ALDEx2 Software

## ALDEx2 as an SSRV

## Benefits of Moving Past Normalizations to Scale

# Coding Changes to ALDEx2

## Including scale

## Option 1: Default Scale Model

## Option 2: More Complex Scale Models

## Sensitivity Analyses

# Real Data Examples

## Real Example: SELEX

## Real Example: Vandputte
